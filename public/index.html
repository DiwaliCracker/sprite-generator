<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video to Sprite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>.loader { transition: width 0.2s; }</style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-2xl">
        <h1 class="text-3xl font-bold mb-6 text-blue-400">Video Sprite Generator</h1>

        <div class="space-y-4">
            <div>
                <label class="block text-sm mb-1">Video URL (Direct .mp4 link)</label>
                <input type="text" id="videoUrl" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-blue-500 outline-none" placeholder="https://example.com/video.mp4">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm mb-1">Thumbnail Width (px)</label>
                    <input type="number" id="thumbWidth" value="160" class="w-full p-2 rounded bg-gray-700 border border-gray-600">
                </div>
                <div>
                    <label class="block text-sm mb-1">Interval (seconds)</label>
                    <input type="number" id="interval" value="5" class="w-full p-2 rounded bg-gray-700 border border-gray-600">
                </div>
            </div>

            <button onclick="processVideo()" id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded transition">
                Generate Sprite
            </button>
        </div>

        <div id="statusSection" class="hidden mt-6">
            <div class="flex justify-between mb-1">
                <span id="statusText" class="text-sm text-gray-300">Initializing...</span>
                <span id="percentage" class="text-sm text-blue-400">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                <div id="progressBar" class="loader bg-blue-500 h-full" style="width: 0%"></div>
            </div>
        </div>

        <div id="resultSection" class="hidden mt-6 p-4 bg-gray-700 rounded text-center">
            <h3 class="text-xl font-bold text-green-400 mb-2">Sprite Generated!</h3>
            
            <a id="downloadLink" download="sprite.png" class="inline-block bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded mb-4 font-bold">
                Download Image
            </a>
            
            <div class="overflow-auto max-h-64 border border-gray-600 rounded">
                <img id="finalImage" class="max-w-full mx-auto" />
            </div>
        </div>
    </div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    const statusText = document.getElementById('statusText');
    const progressBar = document.getElementById('progressBar');
    const percentage = document.getElementById('percentage');

    function updateProgress(msg, percent) {
        statusText.innerText = msg;
        progressBar.style.width = percent + "%";
        percentage.innerText = percent + "%";
    }

    async function processVideo() {
        const videoUrl = document.getElementById('videoUrl').value;
        const width = parseInt(document.getElementById('thumbWidth').value);
        const interval = parseInt(document.getElementById('interval').value);
        // Auto-calculate height assuming 16:9 ratio. You can change this if needed.
        const height = Math.round(width * (9/16)); 

        if (!videoUrl) return alert("Please enter a URL");

        document.getElementById('statusSection').classList.remove('hidden');
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('resultSection').classList.add('hidden');

        try {
            if (!ffmpeg.isLoaded()) {
                updateProgress("Loading Engine...", 10);
                await ffmpeg.load();
            }

            // 1. Download Video via Cloudflare Proxy
            updateProgress("Downloading Video...", 20);
            const proxyRes = await fetch(`/api/proxy?url=${encodeURIComponent(videoUrl)}`);
            if (!proxyRes.ok) throw new Error("Could not fetch video. Link might be broken.");
            const videoData = await proxyRes.arrayBuffer();
            ffmpeg.FS('writeFile', 'input.mp4', new Uint8Array(videoData));

            // 2. Extract Frames
            updateProgress("Extracting Frames (Please wait)...", 40);
            // Command to extract 1 frame every X seconds, resized to width
            await ffmpeg.run('-i', 'input.mp4', '-vf', `fps=1/${interval},scale=${width}:-1`, 'frame_%03d.png');

            // 3. Stitch Images
            updateProgress("Stitching Sprite...", 80);
            const files = ffmpeg.FS('readdir', '/').filter(f => f.startsWith('frame') && f.endsWith('.png'));
            
            if(files.length === 0) throw new Error("No frames could be extracted.");

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const cols = 5; // Number of columns in the grid
            const rows = Math.ceil(files.length / cols);
            
            canvas.width = width * cols;
            canvas.height = height * rows;

            for (let i = 0; i < files.length; i++) {
                const data = ffmpeg.FS('readFile', files[i]);
                const blob = new Blob([data.buffer], {type: 'image/png'});
                const img = await createImageBitmap(blob);
                const x = (i % cols) * width;
                const y = Math.floor(i / cols) * height;
                ctx.drawImage(img, x, y, width, height);
            }

            // 4. Show Result
            updateProgress("Done!", 100);
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                
                // Set Image
                document.getElementById('finalImage').src = url;
                
                // Set Download Link
                const dlLink = document.getElementById('downloadLink');
                dlLink.href = url;
                
                document.getElementById('resultSection').classList.remove('hidden');
                document.getElementById('generateBtn').disabled = false;
                
                // Cleanup memory
                try {
                    ffmpeg.FS('unlink', 'input.mp4');
                    files.forEach(f => ffmpeg.FS('unlink', f));
                } catch(e){}
            }, 'image/png');

        } catch (err) {
            console.error(err);
            updateProgress("Error: " + err.message, 0);
            document.getElementById('generateBtn').disabled = false;
        }
    }
</script>
</body>
</html>
